worker_processes auto;
worker_rlimit_nofile 65535;

events { 
  worker_connections 4096;
  use epoll;
  multi_accept on;
}

rtmp {
  server {
    listen 1935;
    chunk_size 4096;
    
    access_log /var/log/nginx/rtmp_access.log;
    
    application live {
      live on;
      record off;

      # ============================================
      # HLS Configuration - Low Latency + Stability
      # ============================================
      hls on;
      hls_path /mnt/hls;

      # Fragment settings
      hls_fragment 2s;                     # 2s = ổn định hơn 1s
      hls_playlist_length 6s;              # latency ~ 4–7s
      hls_fragment_naming sequential;
      hls_type event;

      # Playlist behavior
      hls_continuous on;
      hls_nested off;
      hls_cleanup on;

      # ============================================
      # RTMP ingest optimization
      # ============================================
      allow publish all;
      allow play all;

      drop_idle_publisher 10s;
      sync 10ms;
      wait_key on;
      wait_video on;
      interleave on;
      meta copy;

      # ============================================
      # Auto cleanup old segments
      # ============================================
      exec_publish bash -c 'find /mnt/hls -type f -mmin +5 -delete';

      # ============================================
      # Event handlers
      # ============================================
      on_publish http://localhost:8080/rtmp/on_publish;
      on_publish_done http://localhost:8080/rtmp/on_publish_done;
    }
  }
}

http {
  # ============================================
  # Performance tuning
  # ============================================
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  keepalive_requests 100;

  client_body_buffer_size 128k;
  client_max_body_size 0;
  client_header_buffer_size 1k;
  large_client_header_buffers 4 8k;
  output_buffers 1 32k;
  postpone_output 1460;

  gzip on;
  gzip_vary on;
  gzip_min_length 256;
  gzip_types text/plain application/vnd.apple.mpegurl;
  gzip_comp_level 5;

  open_file_cache max=1000 inactive=20s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;

  server {
    listen 8080;

    # ============================================
    # HLS serving
    # ============================================
    location /hls {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }

      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods 'GET, OPTIONS, HEAD' always;
      add_header Access-Control-Allow-Headers 'Range, Content-Type, Accept' always;
      add_header Access-Control-Expose-Headers 'Content-Length, Content-Range' always;

      # No-cache for .m3u8
      location ~* \.m3u8$ {
        add_header Cache-Control 'no-cache, no-store, must-revalidate' always;
        add_header Pragma 'no-cache' always;
        add_header Expires '0' always;
        add_header Access-Control-Allow-Origin * always;
        expires -1;
      }

      # tiny cache for .ts
      location ~* \.ts$ {
        add_header Cache-Control 'public, max-age=2' always;
        add_header Access-Control-Allow-Origin * always;
        expires 2s;
      }

      add_header Accept-Ranges bytes always;

      if ($request_method = 'OPTIONS') {
        add_header Access-Control-Max-Age 1728000 always;
        add_header Content-Type 'text/plain; charset=utf-8' always;
        add_header Content-Length 0 always;
        return 204;
      }

      alias /mnt/hls;

      directio 512k;
      read_ahead 512k;
    }

    # ============================================
    # Monitoring
    # ============================================
    location /health {
      access_log off;
      return 200 "healthy\n";
      add_header Content-Type text/plain;
    }

    location /control {
      rtmp_control all;
      add_header Access-Control-Allow-Origin * always;
    }

    location /stat {
      rtmp_stat all;
      rtmp_stat_stylesheet stat.xsl;
      add_header Access-Control-Allow-Origin * always;
    }

    # ============================================
    # RTMP hooks
    # ============================================
    location /rtmp/on_publish {
      access_log /var/log/nginx/rtmp_events.log;
      return 200 "publish\n";
    }

    location /rtmp/on_publish_done {
      access_log /var/log/nginx/rtmp_events.log;
      return 200 "publish_done\n";
    }

    # Debug HLS file browser
    location /debug/files {
      alias /mnt/hls;
      autoindex on;
      autoindex_exact_size off;
      autoindex_localtime on;
    }
  }
}
