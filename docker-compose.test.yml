version: '3.8'

# üß™ TEST ENVIRONMENT - Docker Compose Configuration
# D√†nh ri√™ng cho Integration v√† E2E testing
# D·ªØ li·ªáu l∆∞u trong RAM (tmpfs) ‚Üí T·∫Øt container = m·∫•t h·∫øt ‚Üí An to√†n 100%

services:
  # PostgreSQL Test Database
  postgres-test:
    image: postgres:15
    container_name: lms-postgres-e2e
    restart: "no" # Kh√¥ng t·ª± ƒë·ªông restart
    environment:
      POSTGRES_DB: lms_db
      POSTGRES_USER: lms_user
      POSTGRES_PASSWORD: 123456
    ports:
      - "6543:5432"
    tmpfs:
      # D·ªØ li·ªáu ch·ªâ t·ªìn t·∫°i trong RAM
      # Khi stop container ‚Üí m·∫•t h·∫øt d·ªØ li·ªáu ‚Üí an to√†n tuy·ªát ƒë·ªëi
      - /var/lib/postgresql/data:rw,noexec,nosuid,size=512m
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lms_user -d lms_db"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - test-network
    labels:
      - "com.lms.environment=test"
      - "com.lms.purpose=e2e-testing"

  # Redis Test Cache (Optional - n·∫øu test c·∫ßn Redis)
  redis-test:
    image: redis:7-alpine
    container_name: lms-redis-e2e
    restart: "no"
    command: redis-server --appendonly no --save ""
    ports:
      - "6380:6379"
    tmpfs:
      # Cache c≈©ng l∆∞u trong RAM
      - /data:rw,noexec,nosuid,size=128m
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-network
    labels:
      - "com.lms.environment=test"
      - "com.lms.purpose=e2e-testing"

networks:
  test-network:
    driver: bridge
    name: lms-test-network

# ‚ö†Ô∏è  QUAN TR·ªåNG:
# - D·ªØ li·ªáu l∆∞u trong tmpfs (RAM) ‚Üí kh√¥ng persist
# - M·ªói l·∫ßn start = database m·ªõi s·∫°ch s·∫Ω
# - Port 6543 (kh√¥ng tr√πng v·ªõi DB ch√≠nh port 5432)
# - Kh√¥ng c√≥ volumes ‚Üí kh√¥ng lo backup/cleanup

# üìã C√°ch s·ª≠ d·ª•ng:
#
# 1. Start test environment:
#    docker-compose -f docker-compose.test.yml up -d
#
# 2. Check health:
#    docker-compose -f docker-compose.test.yml ps
#
# 3. Run tests:
#    npm run test:e2e
#
# 4. View logs:
#    docker-compose -f docker-compose.test.yml logs -f
#
# 5. Stop and cleanup:
#    docker-compose -f docker-compose.test.yml down
#
# 6. Full cycle (automated):
#    npm run test:e2e:safe  # start ‚Üí test ‚Üí stop
