# Livestream Architecture Documentation

## ğŸ“‹ Tá»•ng quan

Há»‡ thá»‘ng livestream sá»­ dá»¥ng kiáº¿n trÃºc **RTMP â†’ HLS** vá»›i Nginx-RTMP server:

```
OBS Studio â†’ RTMP (rtmp://localhost:1935/live) 
         â†’ Nginx-RTMP (Docker Container) 
         â†’ HLS (.m3u8 + .ts segments) 
         â†’ Frontend HLS.js Player
```

## ğŸ—ï¸ Kiáº¿n trÃºc chi tiáº¿t

### 1. OBS Studio (Stream Source)
- **Vai trÃ²**: Capture vÃ  encode video/audio
- **Output**: RTMP stream
- **Settings**:
  - Service: Custom
  - Server: `rtmp://127.0.0.1/live`
  - Stream Key: Generated by backend (format: `LS-{24_chars}`)

### 2. Nginx-RTMP (Docker Container)
- **Vai trÃ²**: Nháº­n RTMP stream, convert sang HLS
- **Image**: `tiangolo/nginx-rtmp`
- **Ports**:
  - `1935`: RTMP ingest
  - `8080`: HTTP server (HLS playback)
- **Volume mounts**:
  - Config: `rtmp/nginx.conf` â†’ `/etc/nginx/nginx.conf:ro`
  - HLS files: `rtmp/hls` â†’ `/mnt/hls`

#### HLS Configuration (Low Latency)
```nginx
hls_fragment 1s;              # Fragment 1s (tá»‘i thiá»ƒu)
hls_playlist_length 3s;       # Playlist giá»¯ 3s (giáº£m delay)
hls_type live;                # Live mode (compatibility)
hls_continuous on;            # Giá»¯ playlist liÃªn tá»¥c
hls_nested off;               # File .m3u8 á»Ÿ root
hls_fragment_naming sequential; # Äáº·t tÃªn tuáº§n tá»±
hls_cleanup off;              # Táº¯t auto-cleanup (dÃ¹ng script)
```

#### RTMP Settings (OBS Reconnect Stability)
```nginx
drop_idle_publisher 10s;      # Drop idle publisher
sync 10ms;                    # Sync audio/video
wait_key on;                  # Äá»£i keyframe
wait_video on;                # Äá»£i video stream
buflen 1s;                    # Buffer length
interleave on;                # Interleave audio/video
```

### 3. Backend (Node.js/Express)
- **Vai trÃ²**: **KHÃ”NG xá»­ lÃ½ video**, chá»‰ quáº£n lÃ½ metadata
- **Chá»©c nÄƒng**:
  - Generate `stream_key` (format: `LS-{24_alphanumeric}`)
  - Generate `playback_url` (format: `{HLS_BASE_URL}/{stream_key}.m3u8`)
  - LÆ°u vÃ o database
  - Cung cáº¥p API auth náº¿u cáº§n

#### Environment Variables
```env
HLS_BASE_URL=http://localhost:8080/hls
RTMP_SERVER_URL=rtmp://127.0.0.1/live
STREAM_KEY_PREFIX=LS-
STREAM_KEY_LENGTH=24
WEBRTC_STUN_SERVERS=stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302
WEBRTC_TURN_URLS=turn:turn.yourdomain.com:3478?transport=udp,turn:turn.yourdomain.com:3478?transport=tcp
WEBRTC_TURN_USERNAME=turnuser
WEBRTC_TURN_PASSWORD=super-secret-password
```

#### Service Methods
```typescript
// Generate playback URL tá»« stream key
private generatePlaybackUrl(streamKey: string): string {
  const hlsBaseUrl = env.livestream.hlsBaseUrl;
  const sanitizedKey = this.sanitizeStreamKeyForFilename(streamKey);
  return `${hlsBaseUrl}/${sanitizedKey}.m3u8`;
}
```

### 4. Frontend (React + HLS.js)
- **Vai trÃ²**: Play HLS stream trong browser
- **Library**: `hls.js` (cho Chrome/Edge/Firefox)
- **Native**: Safari/iOS cÃ³ native HLS support

#### HLS.js Configuration (Low Latency)
```typescript
{
  enableWorker: true,
  lowLatencyMode: true,
  
  // Buffer settings
  maxBufferLength: 1,              // 1 fragment Ä‘á»ƒ báº¯t Ä‘áº§u
  maxMaxBufferLength: 3,           // Max 3 fragments (tÆ°Æ¡ng á»©ng playlist_length 3s)
  maxBufferSize: 20 * 1000 * 1000, // 20MB
  
  // Retry logic (Ä‘á»£i stream khá»Ÿi Ä‘á»™ng)
  manifestLoadingTimeOut: 15000,   // 15s timeout
  manifestLoadingMaxRetry: 5,      // Retry 5 láº§n (~30s total)
  manifestLoadingRetryDelay: 3000, // Delay 3s
  
  // Live stream settings
  liveSyncDurationCount: 0,        // Báº¯t Ä‘áº§u ngay
  liveMaxLatencyDurationCount: 2,  // Max latency = 2 fragments (~2s)
  liveBackBufferLength: 0,         // Táº¯t back buffer
}
```

#### Error Handling
- **Non-fatal errors**: Tá»± Ä‘á»™ng recover, khÃ´ng hiá»ƒn thá»‹ error
- **404 errors**: Hiá»ƒn thá»‹ message "Stream chÆ°a báº¯t Ä‘áº§u"
- **Network errors**: Retry vá»›i exponential backoff
- **Media errors**: Tá»± Ä‘á»™ng recover náº¿u cÃ³ thá»ƒ

## ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

```
rtmp/
â”œâ”€â”€ nginx.conf              # Nginx-RTMP configuration
â”œâ”€â”€ hls/                    # HLS files (.m3u8, .ts) - mounted to Docker
â”œâ”€â”€ fix-container.ps1       # Script restart container vá»›i config má»›i
â”œâ”€â”€ check-status.ps1        # Script kiá»ƒm tra status
â”œâ”€â”€ monitor.ps1             # Script monitor real-time
â””â”€â”€ cleanup-hls.ps1         # Script cleanup file cÅ©

backend/src/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ env.config.ts       # Environment config (cÃ³ livestream section)
â””â”€â”€ modules/livestream/
    â”œâ”€â”€ livestream.service.ts    # Service (generate URL, khÃ´ng xá»­ lÃ½ video)
    â”œâ”€â”€ livestream.controller.ts # Controller
    â””â”€â”€ livestream.repository.ts # Repository

frontend/src/
â””â”€â”€ pages/instructor/
    â””â”€â”€ CreateLiveStreamPage.tsx # HLS.js player implementation
```

## ğŸ”§ Setup & Deployment

### Development Setup

1. **Start Nginx-RTMP Container**:
```powershell
cd rtmp
.\fix-container.ps1
```

2. **Configure OBS**:
   - Settings â†’ Stream
   - Service: Custom
   - Server: `rtmp://127.0.0.1/live`
   - Stream Key: Copy tá»« frontend

3. **Start Backend**:
```bash
cd backend
npm run dev
```

4. **Start Frontend**:
```bash
cd frontend
npm run dev
```

### Production Setup

1. **Environment Variables**:
```env
# Backend
HLS_BASE_URL=https://yourdomain.com/hls
RTMP_SERVER_URL=rtmp://yourdomain.com/live
WEBRTC_STUN_SERVERS=stun:stun1.yourdomain.com:3478
WEBRTC_TURN_URLS=turn:turn.yourdomain.com:3478?transport=udp,turn:turn.yourdomain.com:3478?transport=tcp
WEBRTC_TURN_USERNAME=prod-turn-user
WEBRTC_TURN_PASSWORD=prod-turn-password

# Frontend (náº¿u cáº§n)
VITE_HLS_BASE_URL=https://yourdomain.com/hls
```

2. **Docker Container**:
   - Expose ports: `1935` (RTMP), `8080` (HTTP)
   - Mount volumes: config, hls directory
   - Restart policy: `unless-stopped`

3. **Cleanup Script**:
   - Schedule cleanup script má»—i 30 phÃºt
   - XÃ³a file cÅ© hÆ¡n 1 giá»

## ğŸ“Š Performance Metrics

### Latency
- **Target**: 3-5 giÃ¢y
- **Fragment**: 1s
- **Playlist length**: 3s
- **Buffer**: 1-3 fragments

### Stability
- **OBS reconnect**: Tá»± Ä‘á»™ng handle
- **Network errors**: Auto retry
- **Media errors**: Auto recover

## ğŸ”’ Security Considerations

### Current Implementation
- **Stream keys**: Generated randomly, khÃ´ng cÃ³ auth
- **RTMP**: Allow publish all (development)

### Production Recommendations
1. **Stream Key Auth**:
   - Validate stream key trong `on_publish` callback
   - Backend API Ä‘á»ƒ verify stream key
   - JWT token cho stream key

2. **RTMP Security**:
   - IP whitelist cho RTMP publish
   - Stream key validation
   - Rate limiting

3. **HLS Security**:
   - Signed URLs (náº¿u cáº§n)
   - Token-based access
   - CORS restrictions

## ğŸ› Troubleshooting

### Stream khÃ´ng hiá»ƒn thá»‹
1. Kiá»ƒm tra OBS Ä‘Ã£ "Start Streaming" chÆ°a
2. Kiá»ƒm tra stream key cÃ³ khá»›p khÃ´ng
3. Äá»£i 5-10 giÃ¢y Ä‘á»ƒ nginx táº¡o file .m3u8
4. Kiá»ƒm tra container logs: `docker logs nginx-rtmp`

### 404 errors
- File .m3u8 chÆ°a Ä‘Æ°á»£c táº¡o (Ä‘á»£i stream khá»Ÿi Ä‘á»™ng)
- Stream key khÃ´ng khá»›p
- Container mount path sai

### High latency
- Kiá»ƒm tra `hls_fragment` vÃ  `hls_playlist_length`
- Kiá»ƒm tra HLS.js buffer settings
- Kiá»ƒm tra network latency

## ğŸ“š References

- [Nginx-RTMP Module](https://github.com/arut/nginx-rtmp-module)
- [HLS.js Documentation](https://github.com/video-dev/hls.js/)
- [HLS Protocol Spec](https://tools.ietf.org/html/rfc8216)

